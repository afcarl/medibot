(function(){var e={}.hasOwnProperty,t=function(t,n){function i(){this.constructor=t}for(var r in n)e.call(n,r)&&(t[r]=n[r]);return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t},n=function(e,t){return function(){return e.apply(t,arguments)}};Medibot.Models||(Medibot.Models={}),Medibot.Models.Joystick=Backbone.Model.extend({defaults:{sensitivity:.02,sources:["camera","motors"],sourceOn:0,last:{x:0,y:0},pos:{x:0,y:0}},initialize:function(){return this.on("change",function(){var e,t,n;e=this.get("last"),n=this.get("sensitivity"),t=this.get("pos");if(t.x<e.x-n||t.y<e.y-n||t.x>e.x+n||t.y>e.y+n)return Medibot.socket.emit(""+this.source()+":move",t),this.set("last",t)})},source:function(){return this.get("sources")[this.get("sourceOn")]}}),Medibot.Models.Compass=Backbone.Model.extend({defaults:{heading:0,bearing:"North",raw:{x:0,y:0,z:0},scaled:{x:0,y:0,z:0}}}),Medibot.Models.Scanner=Backbone.Model.extend({defaults:{steps:20,range:[0,180],degrees:0}}),Medibot.Models.Ping=Backbone.Model.extend({defaults:{distance:0,min:0,max:140}}),Medibot.Models.Sonar=Backbone.Model.extend({defaults:{ping:{},scanner:{}},initialize:function(){var e=this;return this.set("scanner",new Medibot.Models.Scanner),this.set("ping",new Medibot.Models.Ping),this.get("scanner").on("change",function(){return e.trigger("change")}),this.get("ping").on("change",function(){return e.trigger("change")})}}),Medibot.Models.Notification=Backbone.Model.extend({defaults:{body:"",type:"default",timestamp:Date.now(),priority:0}}),Medibot.Models.Motor=Backbone.Model.extend({defaults:{min:0,max:255,value:0},progress:function(){return this.get("value")/this.get("max")}}),Medibot.Models.Sensor=Backbone.Model.extend({defaults:{min:410,max:565},value:0,progress:function(){return this.get("value")/this.get("max")}}),Medibot.Collections||(Medibot.Collections={}),Medibot.Collections.Notifications=Backbone.Collection.extend({model:Medibot.Models.Notification}),Medibot.Collections.Sensors=Backbone.Collection.extend({model:Medibot.Models.Sensor}),Medibot.Views||(Medibot.Views={}),Medibot.Views.Base=Backbone.View.extend({showFor:function(e,t){var n=this;return this.show(this.animation,function(){var t;return t=setTimeout(function(){return n.hide()},e*1e3),n.$el.on("mouseover",function(){return clearTimeout(t)}),n.$el.on("mouseleave",function(){return n.hide()})}),this},renderChild:function(e,t){return t||(t=this.$el),t.append(e.render().el)},toggle:function(){return this.isVisible?this.hide():this.show()},show:function(e,t){var n=this;return this.animation=e||this.animation,this.animate(this.animation),this.on("animation:complete",function(){n.isVisible=!0,n.trigger("visibility:showing"),n.$el.addClass("active");if(t)return t()})},hide:function(e,t){var n=this;e==null&&(e=this.reverseAnimation(this.animation));if(this.isVisible&&!this.isAnimating)return this.animate(e),this.on("animation:complete",function(){n.isVisible=!1,n.$el.removeClass("active"),n.trigger("visibility:hidden");if(t)return t()})},transition:function(e){var t=this;return this.transition=e||this.transition,this.trigger("transition:started"),this.$el.transitionCSS(e,function(){return t.$el.addClass("active"),t.trigger("transition:complete")})},animate:function(e){var t=this;if(!this.isAnimating)return this.isAnimating=!0,this.trigger("animation:started"),this.$el.animateCSS(e,function(){return t.isAnimating=!1,t.trigger("animation:complete")})},reverseAnimation:function(e){var t,n,r,i,s,o;e==null&&(e=""),n=["Out","In","Down","Up","Right","Left"],i=["In","Out","Up","Down","Left","Right"],r=e;for(s=0,o=n.length;s<o;s++)t=n[s],e.indexOf(t)!==-1&&(r=r.replace(t,i[s]));return r}}),Medibot.Views.RaphaelBase=Backbone.View.extend({tagName:"div",colors:{bg:"rgb(26, 56, 59)",highlight:"rgb(64, 215, 220)",highlight2:"rgba(255, 102, 124)",transparent:"rgba(64, 215, 220, 0.1)",invisible:"rgba(64, 215, 220, 0)",warning:"rgba(244, 54, 6)",glow:"rgb(35,41,37)"},initialize:function(e){return this.options=e!=null?e:{},_.bindAll(this,"draw"),this.model.on("change",this.draw),_.defaults(this.options,{animation:"<>",lineWidth:8,digit:!1,label:!1})},resize:function(e,t){return this.paper.clear(),this.remove(),this.options.width=e,this.options.height=t,this.render()},render:function(){return this.options.label&&this.$el.append("<h3 class='section-label'>"+this.options.label+"</h3>"),this.options.radius?(this.center=this.options.radius+this.options.lineWidth,this.paper=Raphael(this.el,this.center*2,this.center*2)):(this.cx=this.options.width/2+this.options.lineWidth*2,this.cy=this.options.height/2+this.options.lineWidth*2,this.paper=Raphael(this.el,this.options.width,this.options.height)),this.options.digit&&(this.$el.append('<p class="digit">0</p>'),this.$digit=this.$(".digit")),this.paper.customAttributes.arc=function(e,t,n,r,i){var s,o,u,a,f;return o=360/r*n,s=(90-o)*Math.PI/180,a=e+i*Math.cos(s),f=t-i*Math.sin(s),r===n?u=[["M",e,t-i],["A",i,i,0,1,1,e-.01,t-i]]:u=[["M",e,t-i],["A",i,i,0,+(o>180),1,a,f]],{path:u}}}}),Medibot.Views||(Medibot.Views={}),Medibot.Views.BlockGraph=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return t(n,e),n.prototype.className="block-graph section",n.prototype.initialize=function(e){return this.options=e!=null?e:{},n.__super__.initialize.apply(this,arguments),this.options.spacing=this.options.spacing||4,this.options.direction=this.options.direction||"right"},n.prototype.draw=function(){var e,t,n,r,i,s,o,u,a,f,l;o=this.model.progress(),l=[];for(u=a=0,f=this.options.rows-1;0<=f?a<=f:a>=f;u=0<=f?++a:--a)l.push(function(){var a,f,l;l=[];for(t=a=0,f=this.options.cols-1;0<=f?a<=f:a>=f;t=0<=f?++a:--a)e=this.blocks[u][t],s=e.attr("fill-opacity"),this.options.direction==="up"&&(i=Math.floor(this.options.rows-o*this.options.rows),n=s<1&&u>=i,r=s>0&&u<=i),this.options.direction==="right"&&(i=Math.floor(o*this.options.cols),n=s<1&&t<=i,r=s>0&&t>=i),n?l.push(e.animate({"fill-opacity":1},200,this.options.animation)):r?l.push(e.animate({"fill-opacity":0},200,this.options.animation)):l.push(void 0);return l}.call(this));return l},n.prototype.render=function(){var e,t,r,i,s,o,u,a,f,l,c,h,p,d;n.__super__.render.apply(this,arguments),this.blocks=new Array(this.options.rows),h=this.blocks;for(a=0,c=h.length;a<c;a++)e=h[a],this.blocks[a]=new Array(this.options.cols);r=Math.floor(this.options.width/this.options.cols)-this.options.lineWidth-this.options.spacing,t=Math.floor(this.options.height/this.options.rows)-this.options.lineWidth-this.options.spacing,u=this.options.spacing;for(s=f=0,p=this.options.rows-1;0<=p?f<=p:f>=p;s=0<=p?++f:--f){o=this.options.spacing;for(i=l=0,d=this.options.cols-1;0<=d?l<=d:l>=d;i=0<=d?++l:--l)e=this.paper.rect(o,u,r,t).attr({stroke:this.colors.bg,fill:this.colors.highlight,"fill-opacity":0,"stroke-width":this.options.lineWidth}),this.blocks[s][i]=e,o+=r+this.options.spacing;u+=t+this.options.spacing}return this},n}(Medibot.Views.RaphaelBase),Medibot.Views||(Medibot.Views={}),Medibot.Views.CircularGraph=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return t(n,e),n.prototype.className="circular-graph section",n.prototype.draw=function(){var e,t;t=this.model.get("value"),e=this.model.get("max");if(!(t>e))return this.options.digit&&this.$digit.text(t),this.circle.animate({arc:[this.center,this.center,t,e,this.options.radius]},200,this.options.animation)},n.prototype.render=function(){return n.__super__.render.apply(this,arguments),this.bg=this.paper.circle(this.center,this.center,this.options.radius).attr({stroke:this.colors.bg,"stroke-width":this.options.lineWidth}),this.circle=this.paper.path().attr({stroke:this.colors.highlight,"stroke-width":this.options.lineWidth,arc:[this.center,this.center,0,255,this.options.radius]}),this},n}(Medibot.Views.RaphaelBase),Medibot.Views||(Medibot.Views={}),Medibot.Views.Compass=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return t(n,e),n.prototype.className="compass section",n.prototype.draw=function(){return this.paper},n.prototype.render=function(){return n.__super__.render.apply(this,arguments),this.paper.circle(this.center,this.center,this.options.radius).attr({stroke:this.colors.bg,"stroke-width":this.options.lineWidth,"stroke-dasharray":"--","stroke-linecap":"butt"}),this.paper.path("M23.383,0C19.415,0,0,70.15,0,70.15l23.383-23.384L46.767,70.15C46.767,70.15,27.352,0,23.383,0z"),this},n}(Medibot.Views.RaphaelBase),Medibot.Views||(Medibot.Views={}),Medibot.Views.Hud=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return t(n,e),n.prototype.className="hud",n.prototype.template=Handlebars.templates.hud,n.prototype.initialize=function(){var e=this;return Medibot.socket=io.connect("http://192.168.0.193"),this.battery=new Medibot.Models.Sensor({min:410,max:565}),this.motorLeft=new Medibot.Models.Motor,this.motorRight=new Medibot.Models.Motor,this.sonar=new Medibot.Models.Sonar,this.notifications=new Medibot.Collections.Notifications,Medibot.socket.on("read",function(t){return e.battery.set(t.battery),e.sonar.get("ping").set(t.sonar.ping),e.sonar.get("scanner").set(t.sonar.scanner),e.motorLeft.set("value",t.motors.left),e.motorRight.set("value",t.motors.right)}),(this.pad=Gamepads.get(0))?this.initPad():this.joystick=new Medibot.Models.Joystick},n.prototype.initPad=function(){var e,t,n=this;return t=function(e){return Math.round(e*-255)},e=function(e){var t;return t=function(){switch(e){case"BUTTON_12":return"up";case"BUTTON_13":return"down";case"BUTTON_14":return"left";case"BUTTON_15":return"right"}}()},this.pad.on("buttondown",function(t){var n;(n=e(t.button))&&Medibot.socket.emit("camera:move",n);if(t.button==="BUTTON_0")return Medibot.socket.emit("motors:move",[0,0])}),this.pad.on("buttonup",function(t){var n;if(n=e(t.button))return Medibot.socket.emit("camera:move:end",n)}),this.pad.on("axismove",function(e){if(e.button==="AXE_1"||e.button==="AXE_3")return Medibot.socket.emit("motors:move",[t(n.pad.AXE_1),t(n.pad.AXE_3)])})},n.prototype.render=function(){return this.renderTemplate({}),this.$toolbar=this.$(".toolbar"),this.$video=this.$(".video-container"),this.renderChild(new Medibot.Views.Sensor({model:this.battery,radius:20,digit:!1,label:"Battery"}),this.$toolbar),this.renderChild(new Medibot.Views.NotificationFooter({collection:this.notifications})),this.renderChild(new Medibot.Views.Sonar({model:this.sonar,lineWidth:1,radius:90,digit:!1,label:"Sonar"}),this.$toolbar),this.renderChild(new Medibot.Views.BlockGraph({model:this.motorLeft,height:20,width:120,rows:1,cols:10,lineWidth:1,label:"Motor L",direction:"right"}),this.$toolbar),this.renderChild(new Medibot.Views.BlockGraph({model:this.motorRight,height:20,width:120,rows:1,cols:10,lineWidth:1,label:"Motor R",direction:"right"}),this.$toolbar),this.joystick&&this.renderChild(new Medibot.Views.Joystick({model:this.joystick,$parent:this.$video,width:640,height:320,lineWidth:1,digit:!1}),this.$video),this},n}(Medibot.Views.Base),Medibot.Views||(Medibot.Views={}),Medibot.fn={},Medibot.fn.constrain=function(e,t,n){return e<=n&&e>=t?e:e>n?n:t},Medibot.Views.Joystick=function(e){function r(){return this.end=n(this.end,this),this.move=n(this.move,this),this.resize=n(this.resize,this),this.start=n(this.start,this),r.__super__.constructor.apply(this,arguments)}return t(r,e),r.prototype.className="joystick",r.prototype.events={"click .button":"sourceChange"},r.prototype.initialize=function(e){var t=this;return this.options=e!=null?e:{},_.defaults(this.options,{animation:"<>",lineWidth:8,digit:!0,frequency:100}),this.$parent=this.options.$parent,$(window).on("resize",function(){return t.resize()})},r.prototype.start=function(){return this.control.animate({fill:this.colors.highlight2},300,"<>")},r.prototype.resize=function(){var e;return e=$(".video"),this.options.width=e.width(),this.options.height=e.height(),this.render()},r.prototype.move=function(e,t){var n,r,i;return r=this.options.width/2,n=this.options.height/2,e=Medibot.fn.constrain(e,-r,r),t=Medibot.fn.constrain(t,-n,n),i={x:e/r,y:t/n},this.model.set({pos:i}),this.control.attr({cx:this.cx+e,cy:this.cy+t})},r.prototype.end=function(){return this.control.animate({cx:this.cx,cy:this.cy,fill:this.colors.highlight},200,"backOut")},r.prototype.sourceChange=function(e){return this.model.set({sourceOn:$(".buttons li").index($(e.target).parent())})},r.prototype.render=function(){var e;return r.__super__.render.apply(this,arguments),e=this.model.get("sources"),this.$el.append("<ul class='buttons'><li><a href='#' class='button "+e[0]+"-button'>                 "+e[0]+"</a></li><li><a href='#' class='button "+e[1]+"-button'>"+e[1]+"</a></li></ul>"),this.bg=this.paper.rect(0,0,this.options.width,this.options.height).attr({stroke:this.colors.bg,"stroke-width":this.lineWidth}),this.home=this.paper.circle(this.cx,this.cy,30).attr({fill:this.colors.bg,stroke:!1}),this.control=this.paper.circle(this.cx,this.cy,30).attr({stroke:!1,fill:this.colors.highlight,opacity:.7,"stroke-width":this.options.lineWidth}),this.control.drag(this.move,this.start,this.end),this},r}(Medibot.Views.RaphaelBase),Medibot.Views||(Medibot.Views={}),Medibot.Views.NotificationFooter=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return t(n,e),n.prototype.tagName="div",n.prototype.template=Handlebars.templates.notification,n.prototype.className="notification media",n.prototype.animation="fadeInUp fast",n.prototype.initialize=function(e){return e==null&&(e={}),_.bindAll(this,"render"),this.collection.bind("add",this.render)},n.prototype.render=function(){var e;return this.collection.length>0&&(e=this.collection.first(),e.get("priority")>0&&(this.renderTemplate(e.toJSON()),this.showFor(5))),this},n}(Medibot.Views.Base),Medibot.Views||(Medibot.Views={}),Medibot.Views.Sensor=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return t(n,e),n.prototype.className="circular-graph section",n.prototype.tagName="div",n}(Medibot.Views.CircularGraph),Medibot.Views||(Medibot.Views={}),Medibot.Views.Sonar=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return t(n,e),n.prototype.className="sonar-graph section",n.prototype.draw=function(){var e,t,n;return n=this.model.get("scanner"),e=this.model.get("ping"),e.get("distance")<e.get("max")&&(t=this.paper.rect(e.get("distance")/e.get("max")*this.options.radius,this.center-this.options.lineWidth,5,5).rotate(n.get("degrees"),this.center,this.center-this.options.lineWidth).attr({fill:this.colors.highlight,stroke:!1}),t.animate({opacity:0},5e3,this.options.animation,function(){return t.remove()})),this.core.animate({"stroke-width":50,"stroke-opacity":0},500,this.options.animation,function(){return this.attr({"stroke-opacity":1,"stroke-width":0})}),this.beam.animate({transform:"R"+n.get("degrees")+","+this.center+","+(this.center-this.options.lineWidth)},1e3)},n.prototype.render=function(){var e,t,r,i,s,o,u;n.__super__.render.apply(this,arguments),this.paper.setSize(this.center*2,this.center),t=this.model.get("scanner"),e=t.get("range"),i=t.get("steps"),this.beam=this.paper.sector(this.center,this.center-this.options.lineWidth,this.options.radius,e[1]-i,e[1]).attr({fill:this.colors.transparent,stroke:!1}),this.core=this.paper.sector(this.center,this.center-this.options.lineWidth,5,e[0],e[1]).attr({fill:this.colors.highlight,stroke:this.colors.highlight,"stroke-width":0,"stroke-opacity":.2}),u=_.range(this.options.radius,10,-10);for(s=0,o=u.length;s<o;s++)r=u[s],this.paper.sector(this.center,this.center-this.options.lineWidth,r,e[0],e[1]).attr({stroke:this.colors.bg,"stroke-width":1,"stroke-opacity":1});return this},n}(Medibot.Views.RaphaelBase),$.fn.animationComplete=function(e){var t;if(!Modernizr.cssanimations)return setTimeout(e,0),$(this);t="animationend webkitAnimationEnd";if($.isFunction(e))return $(this).one(t,e)},$.fn.animateCSS=function(e,t){return e||(e="none"),$(this).addClass("animated "+e).animationComplete(function(){$(this).removeClass("animated "+e);if(t)return t()}),$(this)},window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(e){return window.setTimeout(e,1e3/60)}}(),$("body").on("touchmove",function(e){return e.preventDefault()}),Raphael.fn.sector=function(e,t,n,r,i){var s,o,u,a,f;return s=Math.PI/180,o=e+n*Math.cos(-r*s),u=e+n*Math.cos(-i*s),a=t+n*Math.sin(-r*s),f=t+n*Math.sin(-i*s),this.path(["M",e,t,"L",o,a,"A",n,n,0,+(i-r>180),0,u,f,"z"])},Raphael.fn.roundedRectangle=function(e,t,n,r,i,s,o,u){var a;return a=[],a=a.concat(["M",e,i+t,"Q",e,t,e+i,t]),a=a.concat(["L",e+n-s,t,"Q",e+n,t,e+n,t+s]),a=a.concat(["L",e+n,t+r-o,"Q",e+n,t+r,e+n-o,t+r]),a=a.concat(["L",e+u,t+r,"Q",e,t+r,e,t+r-u,"Z"]),this.path(a)}}).call(this);